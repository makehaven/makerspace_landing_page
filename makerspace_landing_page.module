<?php

/**
 * @file
 * Primary module hooks for Makerspace Landing Page module.
 */

use Drupal\node\NodeInterface;
use Drupal\Core\Routing\RouteMatchInterface;

/**
 * Implements hook_page_attachments().
 */
function makerspace_landing_page_page_attachments(array &$attachments) {
  $node = \Drupal::routeMatch()->getParameter('node');
  
  if ($node instanceof \Drupal\node\NodeInterface && $node->getType() === 'landing_page') {
      $settings = [];

      if ($node->hasField('field_landing_coupon_code')) {
        if (!$node->get('field_landing_coupon_code')->isEmpty()) {
            $settings['coupon'] = $node->get('field_landing_coupon_code')->value;
        }
      }

      if ($node->hasField('field_landing_tracking_code')) {
         if (!$node->get('field_landing_tracking_code')->isEmpty()) {
            $settings['tracking_code'] = $node->get('field_landing_tracking_code')->value;
         }
      }

      // Attach library.
      $attachments['#attached']['library'][] = 'makerspace_landing_page/landing_page';
      
      if (!empty($settings)) {
        $attachments['#attached']['drupalSettings']['makerspace_landing_page'] = $settings;
      }
  }
}

/**
 * Implements hook_preprocess_node().
 */
function makerspace_landing_page_preprocess_node(&$variables) {
  /** @var \Drupal\node\NodeInterface $node */
  $node = $variables['node'];
  
  // We handle library attachment in page_attachments now to be safe.
  // But we still need to hide the fields if they exist.
  
  if ($node->getType() !== 'landing_page') {
    return;
  }

  if ($node->hasField('field_landing_coupon_code') && isset($variables['content']['field_landing_coupon_code'])) {
      $variables['content']['field_landing_coupon_code']['#access'] = FALSE;
  }

  if ($node->hasField('field_landing_tracking_code') && isset($variables['content']['field_landing_tracking_code'])) {
      $variables['content']['field_landing_tracking_code']['#access'] = FALSE;
  }
}

/**
 * Implements hook_preprocess_paragraph().


/**
 * Implements hook_preprocess_paragraph().
 * 
 * Replaces tokens [coupon], [tracking_code] in paragraph text.
 */
function makerspace_landing_page_preprocess_paragraph(&$variables) {
  /** @var \Drupal\paragraphs\Entity\Paragraph $paragraph */
  $paragraph = $variables['paragraph'];
  $parent = $paragraph->getParentEntity();

  if (!$parent || $parent->getEntityTypeId() !== 'node' || $parent->bundle() !== 'landing_page') {
    return;
  }

  $replacements = [];
  
  // Get Coupon
  if ($parent->hasField('field_landing_coupon_code') && !$parent->get('field_landing_coupon_code')->isEmpty()) {
    $replacements['[coupon]'] = $parent->get('field_landing_coupon_code')->value;
    $replacements['[coupon_code]'] = $parent->get('field_landing_coupon_code')->value;
  }

  // Get Tracking Code
  if ($parent->hasField('field_landing_tracking_code') && !$parent->get('field_landing_tracking_code')->isEmpty()) {
    $tracking = $parent->get('field_landing_tracking_code')->value;
    $replacements['[tracking_code]'] = $tracking;
    $replacements['[tracking]'] = $tracking;
  }

  if (empty($replacements)) {
    return;
  }

  // Helper to recursively replace in render array
  _makerspace_landing_page_recursive_replace($variables['content'], $replacements);
}

/**
 * Helper to recursively replace strings in render array.
 */
function _makerspace_landing_page_recursive_replace(&$element, $replacements) {
  if (!is_array($element)) {
    return;
  }

  foreach ($element as $key => &$value) {
    // Skip properties
    if (strpos((string)$key, '#') === 0 && !in_array($key, ['#text', '#markup', '#title', '#plain_text'])) {
      continue;
    }
    
    if (is_array($value)) {
      _makerspace_landing_page_recursive_replace($value, $replacements);
    } elseif (is_string($value)) {
      // Perform replacement
      $value = strtr($value, $replacements);
    }
  }
}

/**
 * Implements hook_theme().
 */
function makerspace_landing_page_theme() {
  return [
    'node__landing_page__full' => [
      'base hook' => 'node',
    ],
  ];
}
