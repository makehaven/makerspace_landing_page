<?php

/**
 * @file
 * Primary module hooks for Makerspace Landing Page module.
 */

use Drupal\node\NodeInterface;

/**
 * Implements hook_preprocess_node().
 */
function makerspace_landing_page_preprocess_node(&$variables) {
  /** @var \Drupal\node\NodeInterface $node */
  $node = $variables['node'];

  if ($node->getType() !== 'landing_page') {
    return;
  }

  // Only attach on full page view.
  if ($variables['view_mode'] !== 'full') {
      return;
  }

  $settings = [];

  if ($node->hasField('field_landing_coupon_code') && !$node->get('field_landing_coupon_code')->isEmpty()) {
    $settings['coupon'] = $node->get('field_landing_coupon_code')->value;
    // Hide the field from being rendered if it's in the content array.
    if (isset($variables['content']['field_landing_coupon_code'])) {
        $variables['content']['field_landing_coupon_code']['#access'] = FALSE;
    }
  }

  if ($node->hasField('field_landing_tracking_code') && !$node->get('field_landing_tracking_code')->isEmpty()) {
    $settings['tracking_code'] = $node->get('field_landing_tracking_code')->value;
    // Hide the field.
    if (isset($variables['content']['field_landing_tracking_code'])) {
        $variables['content']['field_landing_tracking_code']['#access'] = FALSE;
    }
  }

  // Attach library.
  $variables['#attached']['library'][] = 'makerspace_landing_page/landing_page';
  
  if (!empty($settings)) {
    $variables['#attached']['drupalSettings']['makerspace_landing_page'] = $settings;
  }
}
